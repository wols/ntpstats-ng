= Übertragung
:icons:         font
:imagesdir:     ../../../images
:imagesoutdir:  ../../../images
:linkattrs:
:toc:           macro
:toc-title:     Inhalt

Übertragung von NTP Statistken mit Hilfe von syslog-ng - cool!

IMPORTANT: Dieses Kapitel wird noch editiert und ist noch nicht abgeschlossen.

toc::[]

== Datenfluss

Zur Übertragung von NTP Statistiken kann ein Syslog Daemon - hier `syslog-ng` - benutzt werden.
Der Syslog-_Client_ sendet die Daten via Netzwerk an den Syslog-_Server_.

Logstash kann mit `logstash-input-tcp` sehr einfach als Syslog-Server fungieren.

.syslog-ntp Datenfluss
ifeval::["{{gitbook.version}}" != "3.2.2"]
ifndef::env-github[]
[ditaa, target="diagram/syslog-ntp_dataflow", png]
----
+-----------+      /-----------\     /-------+----------+--------\   +---------------+   /---------\
| loopstats +----->|           |     |       |          |        |   |               |   |         |
+-----------+      | syslog-ng *--=->* input | Logstash | output +-->* Elasticsearch *-->| Grafana |
| peerstats |  +-->|           |     |       |          |        |   |{s}            |   |         |
|{d}        +--+   \-----------/     \---+---+----------+--------/   +---------------+   \---------/
+-----------+                            |                  ^
                                         |   +----------+   |
                                         +---+  filter  +---+
                                             +----------+
----
endif::env-github[]
ifdef::env-github[]
image::diagram/syslog-ntp_dataflow.png[]
endif::env-github[]
endif::[]
ifeval::["{{gitbook.version}}" == "3.2.2"]
image::diagram/syslog-ntp_dataflow.png[]
endif::[]

== syslog-ng

=== options

.syslog-ng-3.7.3
[source%nowrap]
----
options {
    # ...
    ts_format(iso);
};
----

=== source

[source%nowrap]
----
source loopstats {
    file(
        "/var/log/ntp/stats/HOSTNAME.loopstats"
        follow-freq(5)
        flags(no-parse)
    );
};

source peerstats {
    file(
        "/var/log/ntp/stats/HOSTNAME.peerstats"
        follow-freq(5)
        flags(no-parse)
    );
};
----

=== destination

[source%nowrap]
----
destination syslog-ntp {
    network(
        "localhost"
        port(5123)
        transport("tcp")
        template("${TAGS} ${MSG}\n") # <1>
        template-escape(no)
    );
};
----
<1> `"TAGS" = ".source.loopstats"` bzw. `"TAGS" = ".source.peerstats"`

=== log

[source%nowrap]
----
log {
    source(loopstats);
    source(peerstats);
    destination(syslog-ntp);
};
----

== Logstash

.logstash-5.1.2
[source%nowrap]
----
# /etc/logstash/conf.d/ntpstats-ng.conf.syslog-ntp
input {
    tcp { ... } # <1>
}

filter {
    grok { ... } # <2>
    mutate { ... } # <3>
}

output {
    file { ... } # <4>
    elasticsearch { ... } # <5>
}
----
<1> xref:syslog-ntp.adoc#logstash-input-tcp[tcp]
<2> xref:syslog-ntp.adoc#logstash-filter-grok[grok]
<3> xref:syslog-ntp.adoc#logstash-filter-mutate[mutate]
<4> xref:syslog-ntp.adoc#logstash-output-file[file]
<5> xref:syslog-ntp.adoc#logstash-output-elasticsearch[elasticsearch]

'''

NOTE: Die komplette Datei findet sich hier: link:https://github.com/wols/ntpstats-ng/blob/master/etc/logstash/conf.d/ntpstats-ng.conf.syslog-ntp[ntpstats-ng.conf.syslog-ntp, window="_blank"]

'''

=== input

==== [[logstash-input-tcp]]tcp

[source%nowrap]
----
input {
    tcp {
        port => 5123
        mode => "server"
        type => "syslog-ntp"
    }
}
----

=== filter

Die folgenden Filter werden nur auf die typisierten Events angewandt.

[source%nowrap]
----
filter {
    if [type] == "syslog-ntp" {
----

==== [[logstash-filter-grok]]grok

[source%nowrap]
----
        grok {
            match        => { "message" => "%{WORD:syslog_tags} %{GREEDYDATA:message}" }
            overwrite    => [ "message" ]
            remove_field => [ "port" ]
        }
----

==== [[logstash-filter-mutate]]mutate

[source%nowrap]
----
        if [syslog_tags] =~ "stats" {
            mutate {
                replace      => { "type" => "%{syslog_tags}" } # <1>
                add_field    => { "path" => "%{host}.%{type}" }
                remove_field => [ "syslog_tags" ]
            }
        }
----
<1> `type` = [line-through]#`"syslog-ng"`# = `"loopstats|peerstats"`

[source%nowrap]
----
    }
}
----

=== output

[source%nowrap]
----
output {
    if [type] == "loopstats"
    or [type] == "peerstats" {
----

==== [[logstash-output-file]]file

[source%nowrap]
----
        # DEBUG
        file {
            path => "/tmp/%{elastic_index}.json"
        }
----

==== [[logstash-output-elasticsearch]]elasticsearch

[source%nowrap]
----
        if  ! ( "_grokparsefailure" in [tags] ) {
            elasticsearch {
                hosts => [ "localhost:9200" ]
                index => "%{elastic_index}"
            }
        }
----

[source%nowrap]
----
    }
}
----

== Variante 2

Eine vielleicht bereits bestehende Syslog-Verbindung durch `syslog-ng` kann zur Übertragung erweitert werden.

.syslog-ntp Datenfluss Variante 2
ifeval::["{{gitbook.version}}" != "3.2.2"]
ifndef::env-github[]
[ditaa, target="diagram/syslog-ntp_dataflow_2", png]
----
+-----------+      /-----------\
| loopstats +----->| syslog-ng |
+-----------+      |           *--+
| peerstats |  +-->|  client   |  |
|{d}        +--+   \-----------/  |
+-----------+                     |
                                  |
+------------------------------=--+
|
|  /-----------\   +-----------+     /-------+----------+--------\   +---------------+   /---------\
|  | syslog-ng |   | loopstats +---->|       |          |        |   |               |   |         |
+->*           +-->+-----------+     | input | Logstash | output +-->* Elasticsearch *-->| Grafana |
   |  server   |   | peerstats |  +->|       |          |        |   |{s}            |   |         |
   \-----------/   |{d}        +--+  \---+---+----------+--------/   +---------------+   \---------/
                   +-----------+         |                  ^
                                         |   +----------+   |
                                         +---+  filter  +---+
                                             +----------+
----
endif::env-github[]
ifdef::env-github[]
image::diagram/syslog-ntp_dataflow_2.png[]
endif::env-github[]
endif::[]
ifeval::["{{gitbook.version}}" == "3.2.2"]
image::diagram/syslog-ntp_dataflow_2.png[]
endif::[]

[line-through]#Die Verarbeitung auf dem Server erfolgt wie bereits für xref:loopstats.adoc#logstash-input-file[loopstats] und xref:peerstats.adoc#logstash-input-file[peerstats] beschrieben.#

'''

link:../README.adoc[ntpstats-ng] (C) MMXV-MMXVII WOLfgang Schricker

// End of ntpstats-ng/doc/de/doc/NTPstats-NG/syslog-ntp.adoc
